(window.webpackJsonp=window.webpackJsonp||[]).push([[97],{"862v":function(t,e,i){"use strict";i.r(e),i.d(e,"MapPageModule",(function(){return j}));var n=i("ofXK"),o=i("3Pt+"),a=i("tyNb"),s=i("TEn/"),l=i("mrSG"),r=i("ShvM"),c=i("H7h6"),d=i("8Cf4"),h=i("fXoL");function p(t,e){1&t&&(h.Pb(0,"ion-label"),h.pc(1,"No device gps data"),h.Ob())}function g(t,e){1&t&&(h.Pb(0,"ion-label"),h.pc(1,"No nearby clients"),h.Ob())}function b(t,e){if(1&t&&(h.Pb(0,"ion-item"),h.nc(1,p,2,0,"ion-label",2),h.nc(2,g,2,0,"ng-template",null,3,h.oc),h.Ob()),2&t){const t=h.jc(3),e=h.Zb();h.Ab(1),h.fc("ngIf",0==e.hasDeviceLocation)("ngIfElse",t)}}function u(t,e){if(1&t&&(h.Pb(0,"ion-item"),h.pc(1),h.Ob()),2&t){const t=e.$implicit;h.Ab(1),h.sc(" ",t.fullName," (",t.distanceFromDevice,"m) ")}}function f(t,e){if(1&t&&(h.Nb(0),h.nc(1,u,2,2,"ion-item",4),h.Mb()),2&t){const t=h.Zb();h.Ab(1),h.fc("ngForOf",t.nearbyClients)}}let v=(()=>{class t{constructor(t){this.popover=t,this.onallClientsChanged=new h.n}onAllClientsChange(t){this.popover.dismiss({allClientsOnMap:this.allClientsOnMap})}}return t.\u0275fac=function(e){return new(e||t)(h.Kb(s.S))},t.\u0275cmp=h.Eb({type:t,selectors:[["app-map-menu"]],inputs:{allClientsOnMap:"allClientsOnMap",hasDeviceLocation:"hasDeviceLocation",nearbyClients:"nearbyClients"},outputs:{onallClientsChanged:"onallClientsChanged"},decls:6,vars:3,consts:[[3,"ngModel","ionChange","ngModelChange"],[4,"ngIf"],[4,"ngIf","ngIfElse"],["elseBlock",""],[4,"ngFor","ngForOf"]],template:function(t,e){1&t&&(h.Pb(0,"ion-item"),h.Pb(1,"ion-label"),h.pc(2,"Show my clients"),h.Ob(),h.Pb(3,"ion-toggle",0),h.Xb("ionChange",(function(t){return e.onAllClientsChange(t)}))("ngModelChange",(function(t){return e.allClientsOnMap=t})),h.Ob(),h.Ob(),h.nc(4,b,4,2,"ion-item",1),h.nc(5,f,2,1,"ng-container",1)),2&t&&(h.Ab(3),h.fc("ngModel",e.allClientsOnMap),h.Ab(1),h.fc("ngIf",0==e.hasDeviceLocation||0===e.nearbyClients.length),h.Ab(1),h.fc("ngIf",e.hasDeviceLocation&&e.nearbyClients.length>0))},directives:[s.w,s.z,s.K,s.c,o.c,o.d,n.k,n.j],styles:[""]}),t})();var m=i("PZfV"),y=i("fGQ8"),C=i("pxUr");const O=["content"],w=["*"];let P=(()=>{let t=class{constructor(t,e){this._mapsWrapper=t,this._markerManager=e,this.visible=!0,this.zIndex=1,this.markerClick=new h.n,this.openInfoWindow=!0,this.infoWindow=new h.D,this.draggable=!1,this._observableSubscriptions=[]}ngAfterViewInit(){const t=this.template.nativeElement.getElementsByTagName("agm-info-window");for(let e=t.length-1;e>=0;--e)t[e].parentNode.removeChild(t[e]);this.load().then(()=>{this.onChanges=this.onChangesOverride})}ngAfterContentInit(){this.infoWindow.changes.subscribe(()=>this.handleInfoWindowUpdate())}ngOnChanges(t){this.onChanges(t)}onChanges(t){}onChangesOverride(t){(t.latitude||t.longitude||t.zIndex)&&(this.overlayView.latitude=this.latitude,this.overlayView.longitude=this.longitude,this.overlayView.zIndex=this.zIndex,this.destroy().then(()=>this.load()))}ngOnDestroy(){this.destroy()}destroy(){this.destroyed=!0;const t=this._markerManager.deleteMarker(this.overlayView);return this.overlayView&&(this.overlayView.div&&this.overlayView.remove(),this.overlayView.setMap(null)),this._observableSubscriptions.forEach(t=>t.unsubscribe()),delete this.overlayView,t}handleInfoWindowUpdate(){if(this.infoWindow.length>1)throw new Error("Expected no more than one info window.");this.infoWindow.forEach(t=>{t.hostMarker=this.overlayView})}load(){return this._mapsWrapper.getNativeMap().then(t=>{const e=this.getOverlay(t);return this._markerManager.addMarker(e),this._addEventListeners(),this._markerManager.getNativeMarker(e)}).then(t=>{const e=t.setMap;t.map&&this.overlayView.setMap(t.map),t.setMap=i=>{e.call(t,i),this.overlayView&&this.overlayView.setMap(i)}})}getOverlay(t){this.overlayView=this.overlayView||new google.maps.OverlayView,this.overlayView.iconUrl=" ",this.overlayView.latitude=this.latitude,this.overlayView.longitude=this.longitude,this.overlayView.visible=!1,this.bounds&&(this.overlayView.bounds_=new google.maps.LatLngBounds(new google.maps.LatLng(this.latitude+this.bounds.x.latitude,this.longitude+this.bounds.x.longitude),new google.maps.LatLng(this.latitude+this.bounds.y.latitude,this.longitude+this.bounds.y.longitude)));const e=this.template.nativeElement.children[0],i=t=>{this.template.nativeElement.appendChild(t)};return this.overlayView.remove=function(){this.div&&(this.div.parentNode.removeChild(this.div),i(this.div),delete this.div)},this.overlayView.getDiv=function(){return this.div},this.overlayView.draw=function(){if(!this.div){this.div=e;const t=this.getPanes();if(!t||!t.overlayImage)return;t.overlayImage.appendChild(e)}const t=new google.maps.LatLng(this.latitude,this.longitude),i=this.getProjection();if(!i)return;const n=i.fromLatLngToDivPixel(t);if(n&&(e.style.left=n.x-10+"px",e.style.top=n.y-20+"px"),this.bounds_){const t=this.getProjection(),e=t.fromLatLngToDivPixel(this.bounds_.getSouthWest()),i=t.fromLatLngToDivPixel(this.bounds_.getNorthEast());this.div.style.left=e.x+"px",this.div.style.top=i.y+"px",this.div.children[0].style.width=i.x-e.x+"px",this.div.children[0].style.height=e.y-i.y+"px"}},e.addEventListener("click",t=>{this.handleTap(),t.stopPropagation()}),this.handleInfoWindowUpdate(),this.overlayView}handleTap(){this.openInfoWindow&&this.infoWindow.forEach(t=>{t.open()}),this.markerClick.emit(null)}_addEventListeners(){const t=this._markerManager.createEventObservable("click",this.overlayView).subscribe(()=>this.handleTap());this._observableSubscriptions.push(t)}};return t.\u0275fac=function(e){return new(e||t)(h.Kb(C.e),h.Kb(C.f))},t.\u0275cmp=h.Eb({type:t,selectors:[["agm-overlay"]],contentQueries:function(t,e,i){var n;1&t&&h.Db(i,C.b,!1),2&t&&h.ic(n=h.Yb())&&(e.infoWindow=n)},viewQuery:function(t,e){var i;1&t&&h.tc(O,!0,h.l),2&t&&h.ic(i=h.Yb())&&(e.template=i.first)},inputs:{visible:"visible",zIndex:"zIndex",openInfoWindow:"openInfoWindow",draggable:["markerDraggable","draggable"],latitude:"latitude",longitude:"longitude",bounds:"bounds"},outputs:{markerClick:"markerClick"},features:[h.yb],ngContentSelectors:w,decls:4,vars:0,consts:[["content",""],[2,"position","absolute"]],template:function(t,e){1&t&&(h.ec(),h.Pb(0,"div",null,0),h.Pb(2,"div",1),h.dc(3),h.Ob(),h.Ob())},encapsulation:2}),t})(),M=(()=>{let t=class{};return t.\u0275mod=h.Ib({type:t}),t.\u0275inj=h.Hb({factory:function(e){return new(e||t)},imports:[[n.b]]}),t})();var x=i("kUBF");function k(t,e){if(1&t&&(h.Pb(0,"ion-badge",6),h.pc(1),h.Ob()),2&t){const t=h.Zb();h.Ab(1),h.qc(t.nearbyClientsCount)}}function L(t,e){if(1&t&&(h.Pb(0,"agm-overlay",10),h.Pb(1,"div",11),h.Lb(2,"div",12),h.Lb(3,"div",13),h.Ob(),h.Ob()),2&t){const t=h.Zb(2);h.fc("latitude",t.devicePositionLat)("longitude",t.devicePositionLng)}}function A(t,e){if(1&t){const t=h.Qb();h.Pb(0,"agm-overlay",10),h.Pb(1,"div",14),h.Xb("click",(function(){h.kc(t);const i=e.$implicit;return h.Zb(2).clientOnMapClicked(i.id)})),h.Pb(2,"ion-avatar"),h.Lb(3,"img",15),h.Ob(),h.Ob(),h.Ob()}if(2&t){const t=e.$implicit;h.fc("latitude",t.address.coordinates.latitude)("longitude",t.address.coordinates.longitude),h.Ab(3),h.fc("src",t.profilePicture,h.lc)}}function I(t,e){if(1&t){const t=h.Qb();h.Pb(0,"agm-map",7),h.Xb("click",(function(){return h.kc(t),h.Zb().closeDetail()})),h.nc(1,L,4,2,"agm-overlay",8),h.nc(2,A,4,3,"agm-overlay",9),h.Ob()}if(2&t){const t=h.Zb();h.fc("latitude",t.mapStartLat)("longitude",t.mapStartLng)("zoom",13),h.Ab(1),h.fc("ngIf",t.displaySelfMarker),h.Ab(1),h.fc("ngForOf",t.clients)}}function _(t,e){if(1&t){const t=h.Qb();h.Pb(0,"div",24),h.Xb("click",(function(){return h.kc(t),h.Zb(2).closeDetail()})),h.Lb(1,"ion-icon",25),h.Ob()}}function S(t,e){if(1&t){const t=h.Qb();h.Pb(0,"div",24),h.Xb("click",(function(){h.kc(t);const e=h.Zb(2);return e.navigateInExternalApp(e.displayedClient.id)})),h.Lb(1,"ion-icon",26),h.Ob()}}function D(t,e){1&t&&(h.Pb(0,"span",27),h.pc(1,"No data"),h.Ob())}function N(t,e){if(1&t&&(h.Pb(0,"div",28),h.Lb(1,"action-item-card",29),h.Ob()),2&t){const t=h.Zb(2);h.Ab(1),h.fc("headerText",t.displayedClientAction.name)("fromTime",t.displayedClientAction.time)("date",t.displayedClientAction.date)("bgCss","bg-default")}}function V(t,e){if(1&t&&(h.Pb(0,"div",16),h.Pb(1,"ion-grid"),h.Pb(2,"ion-row"),h.Pb(3,"ion-col",17),h.Pb(4,"ion-avatar",18),h.Lb(5,"img",15),h.Ob(),h.Ob(),h.Pb(6,"ion-col",17),h.Pb(7,"div"),h.Pb(8,"h2"),h.pc(9),h.Ob(),h.Pb(10,"span",19),h.pc(11),h.Ob(),h.Ob(),h.Ob(),h.Pb(12,"ion-col",20),h.nc(13,_,2,0,"div",21),h.nc(14,S,2,0,"div",21),h.Ob(),h.Ob(),h.Ob(),h.Pb(15,"h5"),h.pc(16,"Next action:"),h.Ob(),h.nc(17,D,2,0,"span",22),h.nc(18,N,2,4,"div",23),h.Ob()),2&t){const t=h.Zb();h.Ab(3),h.fc("size",t.visualHelper.getMapDetailAvatarGridSize()),h.Ab(2),h.fc("src",t.displayedClient.profilePicture,h.lc),h.Ab(1),h.fc("size",t.visualHelper.getMapDetailNameGridSize()),h.Ab(3),h.qc(t.displayedClient.fullName),h.Ab(2),h.qc(t.displayedClient.address.toString()),h.Ab(2),h.fc("ngIf",0==t.isMobileNativeApp()),h.Ab(1),h.fc("ngIf",t.isMobileNativeApp()),h.Ab(3),h.fc("ngIf",null==t.displayedClientAction),h.Ab(1),h.fc("ngIf",null!=t.displayedClientAction)}}let E=(()=>{class t{constructor(t,e,i,n,o,a,s,l){this.cache=t,this.clientsService=e,this.geolocationHelper=i,this.popoverController=n,this.visualHelper=o,this.platform=a,this.launchNavigator=s,this.alertController=l}isMobileNativeApp(){return this.platform.is("capacitor")}ngOnInit(){return Object(l.a)(this,void 0,void 0,(function*(){this.allClientsOnMap=!1,this.displaySelfMarker=!1,yield this.cache.loaded,yield this.loadCLientsWithNextActions();let t=yield this.geolocationHelper.getCurrentLocation();if(null==t&&this.clients[0]){t=this.clients[0].address.coordinates,this.mapStartLat=+t.latitude,this.mapStartLng=+t.longitude,this.devicePositionLat=+t.latitude,this.devicePositionLng=+t.longitude;let e=yield this.alertController.create({header:"Warning",message:"Your device location is turned off or you didn't give application permission. Some of the features may not work correctly.",buttons:["OK"]});return yield e.present(),void setInterval(()=>this.getMapStartingPostion(),3e4)}null!=t&&(this.mapStartLat=+t.latitude,this.mapStartLng=+t.longitude,this.displaySelfMarker=!0,this.getMapStartingPostion()),setInterval(()=>this.getMapStartingPostion(),3e4)}))}getMapStartingPostion(){return Object(l.a)(this,void 0,void 0,(function*(){let t=yield this.geolocationHelper.getCurrentLocation();null!=t?(this.displaySelfMarker=!0,this.devicePositionLat=+t.latitude,this.devicePositionLng=+t.longitude,this.nearbyClientsCount=this.getNearbyClients().length):this.displaySelfMarker=!1}))}loadCLientsWithNextActions(){return Object(l.a)(this,void 0,void 0,(function*(){let t;t=!1===this.allClientsOnMap?yield this.clientsService.apiClientsTodayScheduledClientsGet():yield this.clientsService.apiClientsAllClientsNextActionsGet(),this.processClients(t)}))}processClients(t){return Object(l.a)(this,void 0,void 0,(function*(){let e=new Array,i=yield this.geolocationHelper.getCurrentLocation();for(let n of t){let t=this.cache.getClientById(n.clientId);if(null==t){let e=yield this.clientsService.apiClientsSingleClientGet(n.clientId);if(t=yield this.cache.mapDtoToClient(e),yield this.cache.getCoordinatesIfNeeded(t),yield this.cache.getAddressIfNeeded(t),null!=i){let e=this.geolocationHelper.getDistnaceBetween2Coordinates(i,t.address.coordinates);t.distanceFromDevice=Math.round(e)}}e.push(t)}this.clients=e,this.nextClientActions=t,this.nearbyClientsCount=this.getNearbyClients().length}))}clientOnMapClicked(t){this.nextClientActions.forEach(e=>{e.clientId!==t||(this.displayedClientAction=e.nextAction)}),this.clients.forEach(e=>{e.id!==t||(this.displayedClient=e)})}closeDetail(){this.displayedClient=null,this.displayedClientAction=null}navigateInExternalApp(t){return Object(l.a)(this,void 0,void 0,(function*(){let e=this.clients.find(e=>e.id===t);this.launchNavigator.navigate(`${e.address.coordinates.latitude} ${e.address.coordinates.longitude}`).then(t=>console.log("Launched navigator"),t=>console.log("Error launching navigator",t))}))}presentPopover(t){return Object(l.a)(this,void 0,void 0,(function*(){let e=this.getNearbyClients(),i=yield this.popoverController.create({component:v,componentProps:{allClientsOnMap:this.allClientsOnMap,hasDeviceLocation:this.displaySelfMarker,nearbyClients:e},event:t,translucent:!0});i.present(),i.onDidDismiss().then(t=>{t&&t.data&&(this.allClientsOnMap=t.data.allClientsOnMap,this.loadCLientsWithNextActions())})}))}getNearbyClients(){let t=new Array;return this.clients.forEach(e=>{e.distanceFromDevice<1e3&&t.push(e)}),this.clients.sort((t,e)=>t.distanceFromDevice>e.distanceFromDevice?1:e.distanceFromDevice>t.distanceFromDevice?-1:0),t}}return t.\u0275fac=function(e){return new(e||t)(h.Kb(r.a),h.Kb(c.b),h.Kb(d.a),h.Kb(s.S),h.Kb(m.a),h.Kb(s.R),h.Kb(y.a),h.Kb(s.b))},t.\u0275cmp=h.Eb({type:t,selectors:[["app-map"]],decls:11,vars:3,consts:[["slot","end"],[3,"click"],["color","primary",4,"ngIf"],["name","menu"],[3,"latitude","longitude","zoom","click",4,"ngIf"],["class","detail",4,"ngIf"],["color","primary"],[3,"latitude","longitude","zoom","click"],[3,"latitude","longitude",4,"ngIf"],[3,"latitude","longitude",4,"ngFor","ngForOf"],[3,"latitude","longitude"],[1,"marker"],[1,"pin"],[1,"pin-effect"],[1,"custom-marker",3,"click"],[3,"src"],[1,"detail"],[3,"size"],[1,"client-avatar"],[1,"client-address"],["size","2"],["class","navigate",3,"click",4,"ngIf"],["class","no-data",4,"ngIf"],["class","next-action",4,"ngIf"],[1,"navigate",3,"click"],["name","close"],["name","navigate"],[1,"no-data"],[1,"next-action"],[3,"headerText","fromTime","date","bgCss"]],template:function(t,e){1&t&&(h.Pb(0,"ion-header"),h.Pb(1,"ion-toolbar"),h.Pb(2,"ion-title"),h.pc(3,"Map"),h.Ob(),h.Pb(4,"ion-buttons",0),h.Pb(5,"ion-button",1),h.Xb("click",(function(t){return e.presentPopover(t)})),h.nc(6,k,2,1,"ion-badge",2),h.Lb(7,"ion-icon",3),h.Ob(),h.Ob(),h.Ob(),h.Ob(),h.Pb(8,"ion-content"),h.nc(9,I,3,5,"agm-map",4),h.nc(10,V,19,9,"div",5),h.Ob()),2&t&&(h.Ab(6),h.fc("ngIf",e.displaySelfMarker),h.Ab(3),h.fc("ngIf",e.clients&&e.mapStartLat&&e.mapStartLng),h.Ab(1),h.fc("ngIf",e.displayedClient))},directives:[s.r,s.L,s.J,s.j,s.i,n.k,s.s,s.n,s.h,C.c,n.j,P,s.e,s.q,s.D,s.m,x.a],styles:['agm-map[_ngcontent-%COMP%]{height:100%}.custom-marker[_ngcontent-%COMP%]{position:absolute;cursor:pointer;background:#424242;width:60px;height:60px;left:-30px;top:-30px;border-radius:50%;padding:0;z-index:1001}.custom-marker[_ngcontent-%COMP%]:after{content:"";position:absolute;bottom:-10px;left:20px;border-color:#424242 transparent;border-style:solid;border-width:10px 10px 0;display:block;width:0}.custom-marker[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:50px;height:50px;margin:5px;border-radius:50%}.detail[_ngcontent-%COMP%]{position:absolute;z-index:999;width:100%;height:25%;background-color:hsla(0,0%,39.2%,.8);bottom:0;color:#fff;overflow-y:scroll}.detail[_ngcontent-%COMP%]   .navigate[_ngcontent-%COMP%]{position:absolute;right:0;width:45px;height:45px}.detail[_ngcontent-%COMP%]   .navigate[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{color:#fff;width:100%;height:100%}.detail[_ngcontent-%COMP%]   .next-action[_ngcontent-%COMP%]{margin-bottom:10px;max-width:450px;margin-left:3%}.detail[_ngcontent-%COMP%]   .client-avatar[_ngcontent-%COMP%]{max-width:80px;max-height:80px;margin-top:5px;margin-left:5px}.detail[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin-top:10px}.detail[_ngcontent-%COMP%]   .client-address[_ngcontent-%COMP%], .detail[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin-left:10px;max-width:100%;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.detail[_ngcontent-%COMP%]   .client-address[_ngcontent-%COMP%]{color:#d9d9d9;margin-top:-10px;position:absolute}.detail[_ngcontent-%COMP%]   .no-data[_ngcontent-%COMP%], .detail[_ngcontent-%COMP%]   h5[_ngcontent-%COMP%]{margin-top:10px;margin-left:3%}.marker[_ngcontent-%COMP%]{width:100px;height:100px;position:absolute;display:block}.pin[_ngcontent-%COMP%]{width:20px;height:20px;position:relative;background:#057cff;border:2px solid #fff;border-radius:50%;z-index:1000}.pin-effect[_ngcontent-%COMP%]{width:100px;height:100px;position:absolute;top:-40px;left:-40px;display:block;background:rgba(5,124,255,.6);border-radius:50%;opacity:0;-webkit-animation:pulsate 2.4s ease-out infinite;animation:pulsate 2.4s ease-out infinite}@-webkit-keyframes pulsate{0%{transform:scale(.1);opacity:0}50%{opacity:1}to{transform:scale(1.2);opacity:0}}@keyframes pulsate{0%{transform:scale(.1);opacity:0}50%{opacity:1}to{transform:scale(1.2);opacity:0}}']}),t})();var z=i("hcQm");const W=[{path:"",component:E}];let j=(()=>{class t{}return t.\u0275mod=h.Ib({type:t}),t.\u0275inj=h.Hb({factory:function(e){return new(e||t)},imports:[[n.b,o.a,s.M,z.a,a.j.forChild(W),C.a.forRoot({apiKey:"AIzaSyCQsd5nCdDeiSvHmgbcSt8Fbk7AOLqPmZw"}),M]]}),t})()}}]);